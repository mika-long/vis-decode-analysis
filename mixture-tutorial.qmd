---
title: "mixture-tutorial"
format:
  html: 
    code-fold: false
    reference-location: margin
    df-print: paged
    toc: true
    code-overflow: wrap
---

# Overview 

This is following [this tutorial](https://rpubs.com/jensroes/mixture-models-tutorial) on fitting log-Gaussian mixed-effects mixture models to get familiar with the syntax in stan and `brms`. 

```{r}
#| output: false 
library(rstan)
library(tidyverse)
library(brms)
library(tidybayes)
```

# Prepare data 

```{r}
# Load data
data <- read_csv("https://osf.io/tjms9/download")
head(data)
```

# Mixed Effects Models 

Note that this is just looking at mixed effects^[i.e., fixed effects + random effects] and NOT mixture models, there is NO mixture yet. 

## Gaussian Mixed Effects Models 

Here's the math model: 

$$
\begin{align}
\text{iki}_i &\sim \mathcal{N}(\mu_i, \sigma_e^2) \\ 
\mu_i &= \beta_{\text{location}[i]} + \mu_{\text{participant}[i]} \\ 
\mu_{\text{participant}[i]} &\sim \mathcal{N}(0, \sigma_p^2)
\end{align}
$$

Corresponding `brms` formula: 

```{r}
formula <- bf(iki ~ 0 + location + (1 | participant), 
              family = gaussian())

get_prior(formula = formula, data = data)
```

The priors with `class` value `b` are those corresponding to $\beta_{\text{location}[i]}$. The default versions have them defined to be `flat` but we could redefine them to be weakly informative using student $t$: 

```{r}
prior <- set_prior('student_t(3, 350, 75)', class = 'b')
```

### Fitting the model 

```{r}
#| output: false 
fit_gaus <- brm(formula = formula, 
                data = data,
                prior = prior, 
                chains = 4, 
                cores = 4, 
                iter = 10000, 
                warmup = 5000, 
                sample_prior = TRUE,
                init = 0, 
                seed = 365, 
                file = "models/fit_gaus")
```

Let's see what the fitted model looks like: 

```{r}
summary(fit_gaus)
pp_check(fit_gaus, ndraws = 100)
```

As can be seen from the `pp_check` the fit is pretty bad ... 

```{r}
fixef(fit_gaus)
```

## Log-Gaussian mixed-effects model 

Here's the math model^[the different is that in the previous model, we assumed that $\text{iki}_i \sim \mathcal{N}(\mu_i, \sigma_e^2)$]: 

$$
\begin{align}
\text{iki}_i &\sim \text{log-normal}(\mu_i, \sigma_e^2) \\ 
\mu_i &= \beta_{\text{location}[i]} + \mu_{\text{participant}[i]} \\ 
\mu_{\text{participant}[i]} &\sim \mathcal{N}(0, \sigma_p^2)
\end{align}
$$

And the corresponding `brms` formula: 

```{r}
formula <- bf(iki ~ 0 + location + (1 | participant), 
              family = lognormal())

# set prior in the same way as before, except this time paying attention to log-normal 
prior <- set_prior('student_t(3, 5.85, .5)', class = 'b')
```

### Fitting the model 

```{r}
#| output: false 
fit_lgaus <- brm(formula = formula, 
                 data = data,
                 prior = prior, 
                 chains = 4, 
                 cores = 4, 
                 iter = 10000, 
                 warmup = 5000, 
                 sample_prior = TRUE,
                 init = 0, 
                 seed = 365, 
                 file = "models/fit_lgaus")
```

Check the fitted results: 

```{r}
summary(fit_lgaus)
pp_check(fit_lgaus, ndraws = 100)
```

This has a much nicer posterior fit compared to the Gaussian model. Let's also check the inferred posterior estimates: 

```{r}
fixef(fit_lgaus)
```

Note that these are in log space, so to view the actual estimates we need to view them in `exp` space. 

```{r}
fixef(fit_lgaus) %>% exp()
```

# Two distributions log-Gaussian mixed effects mixture model 

Here's the math model: 

$$
\begin{align}
\text{iki}_i &\sim \theta_{\text{location}[i], \text{participant}[i]} \times \text{log-normal}(\beta + \delta_{\text{location}[i]} + \mu_{\text{participant}[i]}, \sigma^2_{e'_{\text{location}[i]}}) \\ 
&+ (1-\theta_{\text{location}[i], \text{participant}[i]}) \times \text{log-normal}(\beta + \mu_{\text{participant}[i]}, \sigma_{e_{\text{location}[i]}}^2) \\ 
\delta &\sim \mathcal{N}(0, 1), \delta > 0  
\end{align}
$$

```{r}
?glimpse
```

